<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinGraph AI - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .card { background-color: #1e293b; border-radius: 12px; }
        .stat-card { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
        .login-card { background-color: #1e293b; }
        .gradient-text { background: linear-gradient(90deg, #06b6d4, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Fixed heights for all chart containers */
        .chart-container {
            height: 320px;
            max-height: 320px;
            overflow: hidden;
            position: relative;
        }
        
        /* Scrollable sections with fixed max height */
        .scrollable-section {
            max-height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Custom scrollbar styling */
        .scrollable-section::-webkit-scrollbar,
        #transactions-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollable-section::-webkit-scrollbar-track,
        #transactions-container::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 4px;
        }
        
        .scrollable-section::-webkit-scrollbar-thumb,
        #transactions-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        
        .scrollable-section::-webkit-scrollbar-thumb:hover,
        #transactions-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Responsive grid adjustments */
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
                max-height: 250px;
            }
            .scrollable-section {
                max-height: 250px;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="login-card p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold gradient-text">CoinGraph AI</h1>
                <p class="text-gray-400 mt-2">Admin Dashboard</p>
            </div>
            
            <div id="login-error" class="hidden bg-red-500/20 border border-red-500 text-red-400 px-4 py-3 rounded-lg mb-4">
                Invalid credentials
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-400 mb-2">Username</label>
                    <input type="text" id="username" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter username">
                </div>
                <div>
                    <label class="block text-gray-400 mb-2">Password</label>
                    <input type="password" id="password" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter password">
                </div>
                <button onclick="login()" class="w-full bg-gradient-to-r from-cyan-500 to-purple-500 text-white font-semibold py-3 rounded-lg hover:opacity-90 transition">
                    Sign In
                </button>
            </div>
        </div>
    </div>
    
    <!-- Dashboard (Hidden until login) -->
    <div id="dashboard" class="hidden p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold gradient-text">Admin Dashboard</h1>
                <p class="text-gray-400">CoinGraph AI Analytics</p>
            </div>
            <div class="flex items-center gap-4">
                <span id="last-refresh" class="text-gray-400 text-sm">Last updated: --</span>
                <button onclick="refreshData()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Refresh
                </button>
                <button onclick="logout()" class="bg-red-500/20 text-red-400 hover:bg-red-500/30 px-4 py-2 rounded-lg">
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-8 border-b border-slate-700">
            <button onclick="showTab('overview')" id="tab-overview" class="px-6 py-3 font-semibold border-b-2 border-cyan-500 text-cyan-400">
                Overview
            </button>
            <button onclick="showTab('polling')" id="tab-polling" class="px-6 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                Payment Polling
            </button>
            <button onclick="showTab('transactions')" id="tab-transactions" class="px-6 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white">
                Transactions
            </button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Users</p>
                        <p id="stat-users" class="text-3xl font-bold mt-1">--</p>
                        <p id="stat-premium" class="text-green-400 text-sm mt-1">-- premium</p>
                    </div>
                    <div class="bg-cyan-500/20 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Queries</p>
                        <p id="stat-queries" class="text-3xl font-bold mt-1">--</p>
                        <p id="stat-queries-today" class="text-cyan-400 text-sm mt-1">-- today</p>
                    </div>
                    <div class="bg-purple-500/20 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Tokens</p>
                        <p id="stat-tokens" class="text-3xl font-bold mt-1">--</p>
                        <p id="stat-tokens-today" class="text-yellow-400 text-sm mt-1">-- today</p>
                    </div>
                    <div class="bg-yellow-500/20 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                </div>
            </div>
            
            <div class="stat-card p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm">Total Cost</p>
                        <p id="stat-cost" class="text-3xl font-bold mt-1">$--</p>
                        <p id="stat-cost-today" class="text-green-400 text-sm mt-1">$-- today</p>
                    </div>
                    <div class="bg-green-500/20 p-3 rounded-lg">
                        <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Model Usage -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Model Usage</h3>
                <div class="flex items-center gap-8">
                    <div class="flex-1">
                        <div class="flex justify-between mb-2">
                            <span class="text-cyan-400">Haiku (Fast)</span>
                            <span id="haiku-pct" class="font-bold">--%</span>
                        </div>
                        <div class="bg-slate-700 rounded-full h-4 overflow-hidden">
                            <div id="haiku-bar" class="bg-gradient-to-r from-cyan-500 to-cyan-400 h-full rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="haiku-count" class="text-gray-400 text-sm mt-1">-- queries</p>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between mb-2">
                            <span class="text-purple-400">Sonnet (Smart)</span>
                            <span id="sonnet-pct" class="font-bold">--%</span>
                        </div>
                        <div class="bg-slate-700 rounded-full h-4 overflow-hidden">
                            <div id="sonnet-bar" class="bg-gradient-to-r from-purple-500 to-purple-400 h-full rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="sonnet-count" class="text-gray-400 text-sm mt-1">-- queries</p>
                    </div>
                </div>
            </div>
            
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Tool Usage</h3>
                <div class="flex items-center gap-4">
                    <div class="bg-orange-500/20 p-4 rounded-xl">
                        <p id="stat-tool-calls" class="text-4xl font-bold text-orange-400">--</p>
                        <p class="text-gray-400 text-sm">Total Tool Calls</p>
                    </div>
                    <div class="bg-slate-700 p-4 rounded-xl flex-1">
                        <p id="stat-avg-tools" class="text-2xl font-bold">--</p>
                        <p class="text-gray-400 text-sm">Avg. Tools per Query</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Queries Table -->
        <div class="card p-6 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Recent Queries</h3>
                <div class="flex gap-2">
                    <select id="filter-model" onchange="loadQueries()" class="bg-slate-700 rounded-lg px-3 py-2 text-sm">
                        <option value="">All Models</option>
                        <option value="haiku">Haiku</option>
                        <option value="sonnet">Sonnet</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-slate-700">
                            <th class="pb-3 pr-4">Time</th>
                            <th class="pb-3 pr-4">User</th>
                            <th class="pb-3 pr-4">Query</th>
                            <th class="pb-3 pr-4">Model</th>
                            <th class="pb-3 pr-4">Tokens</th>
                            <th class="pb-3 pr-4">Cost</th>
                            <th class="pb-3 pr-4">Tools</th>
                            <th class="pb-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="queries-table">
                        <tr><td colspan="8" class="text-center py-8 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Users Table -->
        <div class="card p-6">
            <h3 class="text-xl font-semibold mb-4">Top Users by Usage</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-gray-400 border-b border-slate-700">
                            <th class="pb-3 pr-4">Wallet/User</th>
                            <th class="pb-3 pr-4">Type</th>
                            <th class="pb-3 pr-4">Queries</th>
                            <th class="pb-3 pr-4">Tokens</th>
                            <th class="pb-3 pr-4">Cost</th>
                            <th class="pb-3 pr-4">First Query</th>
                            <th class="pb-3">Last Query</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr><td colspan="7" class="text-center py-8 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
        
        <!-- Polling Tab -->
        <div id="polling-tab" class="tab-content hidden">
            <!-- Polling Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Active Polls</p>
                            <p id="polling-active" class="text-3xl font-bold mt-1">--</p>
                            <p class="text-cyan-400 text-sm mt-1">monitoring now</p>
                        </div>
                        <div class="bg-cyan-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Poll Interval</p>
                            <p class="text-3xl font-bold mt-1">120s</p>
                            <p class="text-purple-400 text-sm mt-1">every 2 minutes</p>
                        </div>
                        <div class="bg-purple-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Max Duration</p>
                            <p class="text-3xl font-bold mt-1">20min</p>
                            <p class="text-yellow-400 text-sm mt-1">10 attempts max</p>
                        </div>
                        <div class="bg-yellow-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Polling Info Card -->
            <div class="card p-6 mb-8">
                <div class="flex items-start gap-4">
                    <div class="bg-blue-500/20 p-3 rounded-lg">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold mb-2">About Payment Polling</h4>
                        <p class="text-gray-400 text-sm">
                            When a user makes a crypto payment, they're instantly upgraded to premium upon <span class="text-cyan-400">charge:pending</span> status. 
                            A background thread then polls Coinbase Commerce every 120 seconds for up to 10 attempts (20 minutes total) to verify final payment status. 
                            If the payment fails or expires, premium access is automatically revoked.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Active Polling Threads -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">Active Polling Threads</h3>
                    <button onclick="loadPollingStatus()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                </div>
                <div id="polling-threads-container">
                    <div class="text-center py-8 text-gray-500">Loading polling status...</div>
                </div>
            </div>
        </div>
        
        <!-- Transactions Tab -->
        <div id="transactions-tab" class="tab-content hidden">
            <!-- Transaction Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-6 gap-6 mb-8">
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Revenue</p>
                            <p id="tx-revenue" class="text-3xl font-bold mt-1 text-green-400">$--</p>
                            <p class="text-cyan-400 text-sm mt-1">all time</p>
                        </div>
                        <div class="bg-green-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Today's Revenue</p>
                            <p id="tx-revenue-today" class="text-2xl font-bold mt-1 text-cyan-400">$--</p>
                            <p class="text-gray-400 text-sm mt-1"><span id="tx-count-today">--</span> payments</p>
                        </div>
                        <div class="bg-cyan-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Last 7 Days</p>
                            <p id="tx-revenue-7days" class="text-2xl font-bold mt-1 text-yellow-400">$--</p>
                            <p class="text-gray-400 text-sm mt-1">weekly revenue</p>
                        </div>
                        <div class="bg-yellow-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </div>
                    </div>
                </div>
                
                <!-- Avg Transaction removed per admin request -->
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Transactions</p>
                            <p id="tx-total" class="text-2xl font-bold mt-1">--</p>
                            <p class="text-green-400 text-sm mt-1"><span id="tx-confirmed">--</span> confirmed</p>
                        </div>
                        <div class="bg-cyan-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card p-6 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Pending</p>
                            <p id="tx-pending" class="text-2xl font-bold mt-1 text-yellow-400">--</p>
                            <p class="text-gray-400 text-sm mt-1"><span id="tx-pending-revenue">$--</span></p>
                        </div>
                        <div class="bg-yellow-500/20 p-3 rounded-lg">
                            <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Monthly Revenue Chart -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Monthly Revenue (Last 12 Months)</h3>
                    <div class="chart-container">
                        <canvas id="monthly-revenue-chart"></canvas>
                    </div>
                </div>
                
                <!-- Payment Method Distribution -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Payment Methods</h3>
                    <div class="grid grid-cols-3 gap-4 mt-6">
                        <div class="text-center">
                            <div class="bg-purple-500/20 p-4 rounded-lg mb-2">
                                <p id="tx-coinbase" class="text-3xl font-bold text-purple-400">--</p>
                            </div>
                            <p class="text-gray-400 text-sm">Coinbase Commerce</p>
                            <p id="tx-coinbase-revenue" class="text-purple-400 text-sm font-semibold">$--</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-blue-500/20 p-4 rounded-lg mb-2">
                                <p id="tx-stripe" class="text-3xl font-bold text-blue-400">--</p>
                            </div>
                            <p class="text-gray-400 text-sm">Stripe</p>
                            <p id="tx-stripe-revenue" class="text-blue-400 text-sm font-semibold">$--</p>
                        </div>
                        <div class="text-center">
                            <div class="bg-green-500/20 p-4 rounded-lg mb-2">
                                <p id="tx-crypto" class="text-3xl font-bold text-green-400">--</p>
                            </div>
                            <p class="text-gray-400 text-sm">Direct Crypto</p>
                            <p id="tx-crypto-revenue" class="text-green-400 text-sm font-semibold">$--</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Blockchain & Tier Distribution -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Blockchain Distribution -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Blockchain Distribution</h3>
                    <div id="chain-distribution" class="scrollable-section space-y-2">
                        <div class="text-center py-4 text-gray-500">Loading...</div>
                    </div>
                </div>
                
                <!-- Tier Distribution -->
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4">Pricing Tier Distribution</h3>
                    <div id="tier-distribution" class="scrollable-section space-y-2">
                        <div class="text-center py-4 text-gray-500">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Filters -->
            <div class="card p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">Filters</h3>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Payment Method</label>
                        <select id="filter-tx-method" onchange="loadTransactions()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="">All Methods</option>
                            <option value="coinbase_commerce">Coinbase Commerce</option>
                            <option value="stripe">Stripe</option>
                            <option value="crypto">Direct Crypto</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Status</label>
                        <select id="filter-tx-status" onchange="loadTransactions()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="">All Status</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Blockchain</label>
                        <select id="filter-tx-chain" onchange="loadTransactions()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                            <option value="">All Chains</option>
                            <option value="ethereum">Ethereum</option>
                            <option value="polygon">Polygon</option>
                            <option value="base">Base</option>
                            <option value="arbitrum">Arbitrum</option>
                            <option value="optimism">Optimism</option>
                            <option value="avalanche">Avalanche</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Wallet Filter</label>
                        <input type="text" id="filter-tx-wallet" placeholder="0x..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Date From</label>
                        <input type="date" id="filter-tx-from" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    </div>
                    <div>
                        <label class="block text-gray-400 text-sm mb-2">Date To</label>
                        <input type="date" id="filter-tx-to" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm" />
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="loadTransactions()" class="bg-cyan-500 hover:bg-cyan-600 px-4 py-2 rounded-lg text-sm font-semibold">
                        Apply Filters
                    </button>
                    <button onclick="clearTxFilters()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm">
                        Clear
                    </button>
                </div>
            </div>
            
            <!-- Transactions Table -->
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold">All Transactions</h3>
                    <button onclick="loadTransactions()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        Refresh
                    </button>
                </div>
                <div id="transactions-container" class="overflow-x-auto" style="max-height: 600px; overflow-y: auto;">
                    <div class="text-center py-8 text-gray-500">Loading transactions...</div>
                </div>
                <div id="tx-pagination" class="flex justify-between items-center mt-4 pt-4 border-t border-slate-700">
                    <div class="text-gray-400 text-sm">
                        <span id="tx-page-info">Page 1 of 1</span> â€¢ <span id="tx-total-count">0 transactions</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadTransactions(currentTxPage - 1)" id="tx-prev-btn" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm" disabled>Previous</button>
                        <button onclick="loadTransactions(currentTxPage + 1)" id="tx-next-btn" class="bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded text-sm" disabled>Next</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Dynamic API Base URLs - works in both local and production
        const getApiBaseUrl = () => {
            // If running on localhost:5173 (Vite dev), proxy to localhost:8000
            // Otherwise use the same origin as the frontend
            if (window.location.hostname === 'localhost' && window.location.port === '5173') {
                return 'http://localhost:8000';
            }
            // In production or when served from backend, use relative URLs
            return window.location.origin;
        };
        
        const API_BASE_URL = getApiBaseUrl();
        const API_BASE = `${API_BASE_URL}/api/admin`;
        const PAYMENT_API = `${API_BASE_URL}/api/payment`;
        
        let authHeader = '';
        
        console.log('ðŸŒ API URLs configured:', { API_BASE, PAYMENT_API });
        
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('border-cyan-500', 'text-cyan-400');
                btn.classList.add('border-transparent', 'text-gray-400');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Activate tab button
            const activeBtn = document.getElementById('tab-' + tabName);
            activeBtn.classList.remove('border-transparent', 'text-gray-400');
            activeBtn.classList.add('border-cyan-500', 'text-cyan-400');
            
            // Load tab data if needed
            if (tabName === 'polling') {
                loadPollingStatus();
            }
        }
        
        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Create Basic Auth header
            authHeader = 'Basic ' + btoa(username + ':' + password);
            
            // Test credentials with health check
            fetch(API_BASE + '/overview', {
                headers: { 'Authorization': authHeader }
            })
            .then(response => {
                if (response.ok) {
                    // Hide login, show dashboard
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    
                    // Store in session
                    sessionStorage.setItem('adminAuth', authHeader);
                    
                    // Load data
                    refreshData();
                } else {
                    document.getElementById('login-error').classList.remove('hidden');
                }
            })
            .catch(err => {
                console.error('Login error:', err);
                document.getElementById('login-error').classList.remove('hidden');
            });
        }
        
        // Logout
        function logout() {
            sessionStorage.removeItem('adminAuth');
            authHeader = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        
        // Check for existing session
        window.onload = function() {
            const savedAuth = sessionStorage.getItem('adminAuth');
            if (savedAuth) {
                authHeader = savedAuth;
                // Verify still valid
                fetch(API_BASE + '/overview', {
                    headers: { 'Authorization': authHeader }
                })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('login-screen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        refreshData();
                    }
                });
            }
            
            // Enter key on password field
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        };
        
        // Refresh all data
        function refreshData() {
            const activeTab = document.querySelector('[id^="tab-"].border-cyan-500')?.id.replace('tab-', '');
            
            if (activeTab === 'polling') {
                loadPollingStatus();
            } else {
                loadOverview();
                loadQueries();
                loadUsers();
            }
            
            document.getElementById('last-refresh').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
        }
        
        // Load polling status
        function loadPollingStatus() {
            fetch(PAYMENT_API + '/polling-status', {
                headers: { 'Authorization': authHeader }
            })
            .then(r => r.json())
            .then(data => {
                // Update stats
                document.getElementById('polling-active').textContent = data.active_polls || 0;
                
                // Render threads
                const container = document.getElementById('polling-threads-container');
                
                if (!data.threads || Object.keys(data.threads).length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-gray-400 text-lg mb-2">No Active Polling</p>
                            <p class="text-gray-500 text-sm">All payments have been processed or timed out</p>
                        </div>
                    `;
                    return;
                }
                
                // Render each polling thread
                const threadsHtml = Object.entries(data.threads).map(([chargeId, thread]) => {
                    const statusColors = {
                        'starting': 'bg-blue-500/20 text-blue-400',
                        'polling': 'bg-cyan-500/20 text-cyan-400',
                        'completed': 'bg-green-500/20 text-green-400',
                        'failed': 'bg-red-500/20 text-red-400',
                        'timeout': 'bg-yellow-500/20 text-yellow-400'
                    };
                    
                    const statusColor = statusColors[thread.status] || 'bg-gray-500/20 text-gray-400';
                    const attemptsLeft = thread.max_attempts - thread.attempts;
                    const minutesLeft = attemptsLeft * 2; // 120 seconds = 2 minutes
                    const progress = (thread.attempts / thread.max_attempts) * 100;
                    
                    return `
                        <div class="bg-slate-700/50 rounded-lg p-6 mb-4">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h4 class="text-lg font-semibold">Charge: ${chargeId}</h4>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                                            ${thread.status.toUpperCase()}
                                        </span>
                                    </div>
                                    <p class="text-gray-400 text-sm font-mono">
                                        Wallet: ${thread.wallet || 'Unknown'}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <p class="text-2xl font-bold">${thread.attempts}/${thread.max_attempts}</p>
                                    <p class="text-gray-400 text-sm">attempts</p>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-400 mb-2">
                                    <span>Progress</span>
                                    <span>${progress.toFixed(0)}%</span>
                                </div>
                                <div class="bg-slate-800 rounded-full h-3 overflow-hidden">
                                    <div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-full rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <!-- Stats Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <p class="text-gray-400">Coinbase Status</p>
                                    <p class="font-semibold text-cyan-400">${thread.current_status || 'PENDING'}</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Elapsed Time</p>
                                    <p class="font-semibold">${thread.elapsed_minutes?.toFixed(1) || 0} min</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Time Remaining</p>
                                    <p class="font-semibold">~${minutesLeft} min</p>
                                </div>
                                <div>
                                    <p class="text-gray-400">Last Poll</p>
                                    <p class="font-semibold">${thread.last_poll ? formatTimestamp(thread.last_poll) : '--'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = threadsHtml;
            })
            .catch(err => {
                console.error('Error loading polling status:', err);
                document.getElementById('polling-threads-container').innerHTML = `
                    <div class="text-center py-8">
                        <svg class="w-12 h-12 text-red-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-red-400 mb-2">Error Loading Polling Status</p>
                        <p class="text-gray-500 text-sm">${err.message}</p>
                    </div>
                `;
            });
        }
        
        // Load overview stats
        function loadOverview() {
            fetch(API_BASE + '/overview', {
                headers: { 'Authorization': authHeader }
            })
            .then(r => r.json())
            .then(data => {
                document.getElementById('stat-users').textContent = formatNumber(data.total_users);
                document.getElementById('stat-premium').textContent = data.premium_users + ' premium';
                
                document.getElementById('stat-queries').textContent = formatNumber(data.total_queries);
                document.getElementById('stat-queries-today').textContent = formatNumber(data.queries_today) + ' today';
                
                document.getElementById('stat-tokens').textContent = formatNumber(data.total_tokens);
                document.getElementById('stat-tokens-today').textContent = formatNumber(data.tokens_today) + ' today';
                
                document.getElementById('stat-cost').textContent = '$' + data.total_cost.toFixed(2);
                document.getElementById('stat-cost-today').textContent = '$' + data.cost_today.toFixed(4) + ' today';
                
                // Model usage
                document.getElementById('haiku-pct').textContent = data.haiku_percentage.toFixed(1) + '%';
                document.getElementById('haiku-bar').style.width = data.haiku_percentage + '%';
                document.getElementById('haiku-count').textContent = formatNumber(data.haiku_queries) + ' queries';
                
                const sonnetPct = 100 - data.haiku_percentage;
                document.getElementById('sonnet-pct').textContent = sonnetPct.toFixed(1) + '%';
                document.getElementById('sonnet-bar').style.width = sonnetPct + '%';
                document.getElementById('sonnet-count').textContent = formatNumber(data.sonnet_queries) + ' queries';
                
                // Tool usage
                document.getElementById('stat-tool-calls').textContent = formatNumber(data.total_tool_calls);
                document.getElementById('stat-avg-tools').textContent = data.avg_tools_per_query.toFixed(1);
            })
            .catch(err => console.error('Error loading overview:', err));
        }
        
        // Load queries
        function loadQueries() {
            const model = document.getElementById('filter-model').value;
            let url = API_BASE + '/queries?limit=50';
            if (model) url += '&model=' + model;
            
            fetch(url, {
                headers: { 'Authorization': authHeader }
            })
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('queries-table');
                if (!data.queries || data.queries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No queries yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.queries.map(q => `
                    <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td class="py-3 pr-4 text-sm text-gray-400">${formatTime(q.created_at)}</td>
                        <td class="py-3 pr-4 text-sm">${truncateWallet(q.wallet_address)}</td>
                        <td class="py-3 pr-4 text-sm max-w-xs truncate">${q.user_query || '--'}</td>
                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 rounded text-xs ${q.model_name?.includes('haiku') ? 'bg-cyan-500/20 text-cyan-400' : 'bg-purple-500/20 text-purple-400'}">
                                ${q.model_name?.includes('haiku') ? 'Haiku' : 'Sonnet'}
                            </span>
                        </td>
                        <td class="py-3 pr-4 text-sm">${formatNumber(q.total_tokens)}</td>
                        <td class="py-3 pr-4 text-sm text-green-400">$${q.total_cost.toFixed(4)}</td>
                        <td class="py-3 pr-4 text-sm">${q.tool_calls_count}</td>
                        <td class="py-3">
                            <span class="w-3 h-3 rounded-full inline-block ${q.success ? 'bg-green-500' : 'bg-red-500'}"></span>
                        </td>
                    </tr>
                `).join('');
            })
            .catch(err => console.error('Error loading queries:', err));
        }
        
        // Load users
        function loadUsers() {
            fetch(API_BASE + '/users?limit=20&sort_by=total_cost', {
                headers: { 'Authorization': authHeader }
            })
            .then(r => r.json())
            .then(data => {
                const tbody = document.getElementById('users-table');
                if (!data.users || data.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No users yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.users.map(u => `
                    <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                        <td class="py-3 pr-4 text-sm font-mono">${truncateWallet(u.wallet_address)}</td>
                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 rounded text-xs ${u.user_type === 'premium' ? 'bg-yellow-500/20 text-yellow-400' : u.user_type === 'free' ? 'bg-green-500/20 text-green-400' : 'bg-gray-500/20 text-gray-400'}">
                                ${u.user_type}
                            </span>
                        </td>
                        <td class="py-3 pr-4 text-sm">${formatNumber(u.total_queries)}</td>
                        <td class="py-3 pr-4 text-sm">${formatNumber(u.total_tokens)}</td>
                        <td class="py-3 pr-4 text-sm text-green-400">$${u.total_cost.toFixed(4)}</td>
                        <td class="py-3 pr-4 text-sm text-gray-400">${formatDate(u.first_query)}</td>
                        <td class="py-3 text-sm text-gray-400">${formatDate(u.last_query)}</td>
                    </tr>
                `).join('');
            })
            .catch(err => console.error('Error loading users:', err));
        }
        
        // Utility functions
        function formatNumber(n) {
            if (!n) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }
        
        function truncateWallet(addr) {
            if (!addr) return 'Anonymous';
            return addr.slice(0, 6) + '...' + addr.slice(-4);
        }
        
        function formatTime(iso) {
            if (!iso) return '--';
            const d = new Date(iso);
            return d.toLocaleTimeString();
        }
        
        function formatDate(iso) {
            if (!iso) return '--';
            const d = new Date(iso);
            return d.toLocaleDateString();
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '--';
            const d = new Date(timestamp * 1000); // Unix timestamp to milliseconds
            return d.toLocaleTimeString();
        }
        
        // ==================== TRANSACTIONS TAB ====================
        
        let currentTxPage = 1;
        let monthlyRevenueChart = null;
        
        // Load transactions with filters
        function loadTransactions(page = 1) {
            currentTxPage = page;
            
            const method = document.getElementById('filter-tx-method')?.value || '';
            const status = document.getElementById('filter-tx-status')?.value || '';
            const chain = document.getElementById('filter-tx-chain')?.value || '';
            const wallet = document.getElementById('filter-tx-wallet')?.value || '';
            const dateFrom = document.getElementById('filter-tx-from')?.value || '';
            const dateTo = document.getElementById('filter-tx-to')?.value || '';
            
            const params = new URLSearchParams({
                page: page,
                limit: 50
            });
            
            if (method) params.append('payment_method', method);
            if (status) params.append('status', status);
            if (chain) params.append('chain', chain);
            if (wallet) params.append('wallet_filter', wallet);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            
            fetch(`${API_BASE}/transactions?${params.toString()}`, {
                headers: { 'Authorization': authHeader }
            })
            .then(response => response.json())
            .then(data => {
                // Update summary stats
                document.getElementById('tx-total').textContent = data.summary.total_transactions;
                document.getElementById('tx-confirmed').textContent = data.summary.confirmed;
                document.getElementById('tx-pending').textContent = data.summary.pending;
                document.getElementById('tx-pending-revenue').textContent = '$' + data.summary.pending_revenue_usd.toFixed(2);
                document.getElementById('tx-revenue').textContent = '$' + data.summary.total_revenue_usd.toFixed(2);
                document.getElementById('tx-revenue-today').textContent = '$' + data.summary.revenue_today.toFixed(2);
                document.getElementById('tx-count-today').textContent = data.summary.transactions_today;
                document.getElementById('tx-revenue-7days').textContent = '$' + data.summary.revenue_last_7_days.toFixed(2);
                // Payment method breakdown (counts)
                document.getElementById('tx-coinbase').textContent = data.summary.coinbase_commerce;
                document.getElementById('tx-stripe').textContent = data.summary.stripe;
                document.getElementById('tx-crypto').textContent = data.summary.direct_crypto;

                // Revenue by method (trusted server-supplied)
                const revByMethod = data.summary.revenue_by_method || {};
                document.getElementById('tx-coinbase-revenue').textContent = '$' + (revByMethod.coinbase_commerce || 0).toFixed(2);
                document.getElementById('tx-stripe-revenue').textContent = '$' + (revByMethod.stripe || 0).toFixed(2);
                document.getElementById('tx-crypto-revenue').textContent = '$' + (revByMethod.direct_crypto || 0).toFixed(2);
                
                // Render monthly revenue chart
                renderMonthlyRevenueChart(data.analytics.monthly_breakdown);
                
                // Render blockchain distribution
                renderChainDistribution(data.analytics.chain_distribution);
                
                // Render tier distribution
                renderTierDistribution(data.analytics.tier_distribution);
                
                // Render transactions table
                const container = document.getElementById('transactions-container');
                
                if (data.transactions.length === 0) {
                    container.innerHTML = '<div class="text-center py-8 text-gray-500">No transactions found</div>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-gray-400 border-b border-slate-700 text-sm">
                                <th class="pb-3 pr-4">Date</th>
                                <th class="pb-3 pr-4">Wallet</th>
                                <th class="pb-3 pr-4">Provider</th>
                                <th class="pb-3 pr-4">Method</th>
                                <th class="pb-3 pr-4">Chain</th>
                                <th class="pb-3 pr-4">Amount</th>
                                <th class="pb-3 pr-4">Tier</th>
                                <th class="pb-3 pr-4">Status</th>
                                <th class="pb-3">TX Hash</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.transactions.map(tx => `
                                <tr class="border-b border-slate-700/50 hover:bg-slate-700/30">
                                    <td class="py-3 pr-4 text-sm text-gray-400">
                                        ${formatDate(tx.created_at)}<br/>
                                        <span class="text-xs">${formatTime(tx.created_at)}</span>
                                    </td>
                                    <td class="py-3 pr-4 text-sm font-mono">
                                        ${truncateWallet(tx.wallet_address)}
                                        ${tx.user_is_premium ? '<span class="text-yellow-400 ml-1">â˜…</span>' : ''}
                                    </td>
                                    <td class="py-3 pr-4 text-sm">
                                        ${getProviderBadge(tx.provider_short)}
                                    </td>
                                    <td class="py-3 pr-4 text-sm text-gray-300">${tx.payment_method || '--'}</td>
                                    <td class="py-3 pr-4 text-sm">
                                        ${tx.chain_network ? `<span class="px-2 py-1 rounded text-xs bg-blue-500/20 text-blue-400">${tx.chain_network}</span>` : '<span class="text-gray-500">--</span>'}
                                    </td>
                                    <td class="py-3 pr-4 text-sm font-semibold text-green-400">$${tx.amount_usd.toFixed(2)}</td>
                                    <td class="py-3 pr-4 text-sm">
                                        ${tx.pricing_tier ? `<span class="px-2 py-1 rounded text-xs bg-purple-500/20 text-purple-400">${tx.pricing_tier}</span>` : '<span class="text-gray-500">--</span>'}
                                    </td>
                                    <td class="py-3 pr-4 text-sm">
                                        ${getStatusBadge(tx.status)}
                                    </td>
                                    <td class="py-3 text-sm font-mono">
                                        ${tx.transaction_hash ? 
                                            `<a href="${getExplorerUrl(tx.transaction_hash, tx.chain_network)}" target="_blank" class="text-cyan-400 hover:text-cyan-300 flex items-center gap-1">
                                                ${tx.transaction_hash.slice(0, 10)}...
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                                            </a>` : 
                                            (tx.coinbase_charge_id ? `<span class="text-gray-500">${tx.coinbase_charge_code || tx.coinbase_charge_id.slice(0, 10)}...</span>` : '<span class="text-gray-600">--</span>')
                                        }
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                // Update pagination
                document.getElementById('tx-page-info').textContent = `Page ${data.pagination.page} of ${data.pagination.pages}`;
                document.getElementById('tx-total-count').textContent = `${data.pagination.total} transactions`;
                
                document.getElementById('tx-prev-btn').disabled = page <= 1;
                document.getElementById('tx-next-btn').disabled = page >= data.pagination.pages;
            })
            .catch(err => {
                console.error('Error loading transactions:', err);
                document.getElementById('transactions-container').innerHTML = 
                    '<div class="text-center py-8 text-red-400">Error loading transactions</div>';
            });
        }
        
        function renderMonthlyRevenueChart(monthlyData) {
            const ctx = document.getElementById('monthly-revenue-chart');
            if (!ctx) return;
            
            // Destroy existing chart
            if (monthlyRevenueChart) {
                monthlyRevenueChart.destroy();
            }
            
            monthlyRevenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.map(m => m.month),
                    datasets: [{
                        label: 'Revenue (USD)',
                        data: monthlyData.map(m => m.revenue),
                        backgroundColor: 'rgba(6, 182, 212, 0.5)',
                        borderColor: 'rgba(6, 182, 212, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const month = monthlyData[context.dataIndex];
                                    return [
                                        `Revenue: $${month.revenue.toFixed(2)}`,
                                        `Transactions: ${month.transactions}`,
                                        `Confirmed: ${month.confirmed}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value;
                                },
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(148, 163, 184, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        function renderChainDistribution(chainData) {
            const container = document.getElementById('chain-distribution');
            if (!container || chainData.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">No blockchain data</div>';
                return;
            }
            
            const totalChainRevenue = chainData.reduce((sum, c) => sum + c.revenue, 0);
            
            container.innerHTML = chainData.map(chain => {
                const percentage = totalChainRevenue > 0 ? (chain.revenue / totalChainRevenue * 100) : 0;
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold capitalize">${chain.chain}</span>
                                <span class="text-sm text-gray-400">${chain.count} tx</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                                    <div class="bg-gradient-to-r from-cyan-500 to-purple-500 h-full rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold text-green-400">$${chain.revenue.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderTierDistribution(tierData) {
            const container = document.getElementById('tier-distribution');
            if (!container || tierData.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">No tier data</div>';
                return;
            }
            
            const totalTierRevenue = tierData.reduce((sum, t) => sum + t.revenue, 0);
            const tierColors = {
                'basic': 'from-cyan-500 to-cyan-400',
                'pro': 'from-purple-500 to-purple-400',
                'premium': 'from-yellow-500 to-yellow-400',
                'enterprise': 'from-pink-500 to-pink-400',
                'unknown': 'from-gray-500 to-gray-400'
            };
            
            container.innerHTML = tierData.map(tier => {
                const percentage = totalTierRevenue > 0 ? (tier.revenue / totalTierRevenue * 100) : 0;
                const gradient = tierColors[tier.tier] || tierColors['unknown'];
                return `
                    <div class="flex items-center justify-between p-3 bg-slate-700/30 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-semibold capitalize">${tier.tier}</span>
                                <span class="text-sm text-gray-400">${tier.count} tx</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                                    <div class="bg-gradient-to-r ${gradient} h-full rounded-full" style="width: ${percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold text-green-400">$${tier.revenue.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function clearTxFilters() {
            document.getElementById('filter-tx-method').value = '';
            document.getElementById('filter-tx-status').value = '';
            document.getElementById('filter-tx-chain').value = '';
            document.getElementById('filter-tx-wallet').value = '';
            document.getElementById('filter-tx-from').value = '';
            document.getElementById('filter-tx-to').value = '';
            loadTransactions(1);
        }
        
        function getProviderBadge(provider) {
            const badges = {
                'coinbase_commerce': '<span class="px-2 py-1 rounded text-xs bg-purple-500/20 text-purple-400">ðŸª™ Coinbase</span>',
                'stripe': '<span class="px-2 py-1 rounded text-xs bg-blue-500/20 text-blue-400">ðŸ’³ Stripe</span>',
                'crypto': '<span class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">ðŸª™ Crypto</span>',
                'unknown': '<span class="px-2 py-1 rounded text-xs bg-gray-500/20 text-gray-400">Unknown</span>'
            };
            return badges[provider] || badges['unknown'];
        }
        
        function getStatusBadge(status) {
            const badges = {
                'confirmed': '<span class="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">âœ“ Confirmed</span>',
                'pending': '<span class="px-2 py-1 rounded text-xs bg-yellow-500/20 text-yellow-400">â³ Pending</span>',
                'failed': '<span class="px-2 py-1 rounded text-xs bg-red-500/20 text-red-400">âœ— Failed</span>'
            };
            return badges[status] || '<span class="px-2 py-1 rounded text-xs bg-gray-500/20 text-gray-400">' + status + '</span>';
        }
        
        function getExplorerUrl(txHash, chain) {
            const explorers = {
                'ethereum': 'https://etherscan.io/tx',
                'polygon': 'https://polygonscan.com/tx',
                'base': 'https://basescan.org/tx',
                'arbitrum': 'https://arbiscan.io/tx',
                'optimism': 'https://optimistic.etherscan.io/tx',
                'avalanche': 'https://snowtrace.io/tx',
                'bsc': 'https://bscscan.com/tx'
            };
            const explorerBase = explorers[chain?.toLowerCase()] || 'https://polygonscan.com/tx';
            return `${explorerBase}/${txHash}`;
        }
        
        // Update showTab function to load transactions
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'transactions') {
                loadTransactions(1);
            }
        };
    </script>
</body>
</html>
