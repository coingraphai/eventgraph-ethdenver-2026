import React from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import {
  Box,
  Drawer,
  IconButton,
  Button,
  List,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Divider,
  Stack,
  Typography,
} from '@mui/material';
import {
  Menu as MenuIcon,
  Add as AddIcon,
  ChevronLeft as ChevronLeftIcon,
  TrendingUp as PredictionsIcon,
  AccountTree as WorkflowIcon,
  Home as HomeIcon,
  BarChart as MarketsIcon,
  Terminal as TerminalIcon,
  FilterList as ScreenerIcon,
  SmartToy as AgentIcon,
  AccountBalanceWallet as PortfolioIcon,
  Notifications as AlertsIcon,
  Settings as SettingsIcon,
  Science as MarketTestIcon,
  Event as EventsIcon,
} from '@mui/icons-material';
import { useTheme, alpha } from '@mui/material/styles';
import { ThemeToggle } from '../components/ThemeToggle';
import logoWithName from '../assets/logos/Logo With Name White.png';
import logoWithNameWhite from '../assets/logos/Logo With Name.png';

interface SidebarProps {
  open: boolean;
  onToggle: () => void;
  onNewChat: () => void;
  onSelectSession: (sessionId: number) => void;
  activeSessionId?: number | null;
  userId: string;
  refreshTrigger?: number;
}

export const Sidebar: React.FC<SidebarProps> = ({
  open,
  onToggle,
  onNewChat,
  activeSessionId,
  onSelectSession,
  userId,
  refreshTrigger = 0,
}) => {
  const sidebarWidth = open ? 200 : 72;
  const location = useLocation();
  const navigate = useNavigate();
  const theme = useTheme();

  // Terminal navigation tabs
  const terminalTabs = [
    { name: 'Home', icon: HomeIcon, route: '/' },
    { name: 'Events', icon: EventsIcon, route: '/events' },
    { name: 'Terminal', icon: TerminalIcon, route: '/terminal' },
    { name: 'Screener', icon: ScreenerIcon, route: '/screener' },
    { name: 'Agent', icon: AgentIcon, route: '/agent' },
    { name: 'Workflows', icon: WorkflowIcon, route: '/agent-workflows' },
    { name: 'Portfolio', icon: PortfolioIcon, route: '/portfolio' },
    { name: 'Alerts', icon: AlertsIcon, route: '/alerts' },
    { name: 'Settings', icon: SettingsIcon, route: '/settings' },
  ];

  return (
    <>
      <Drawer
        variant="permanent"
        open={open}
        sx={{
          width: sidebarWidth,
          flexShrink: 0,
          '& .MuiDrawer-paper': {
            width: sidebarWidth,
            boxSizing: 'border-box',
          backgroundColor: 'background.default',
          borderRight: 1,
          borderColor: 'divider',
          transition: 'width 0.3s ease-in-out',
          overflowX: 'hidden',
          overflowY: 'hidden', // Prevent sidebar scroll
        },
      }}
    >
      <Box
        sx={{
          display: 'flex',
          flexDirection: 'column',
          height: '100%',
          padding: open ? '16px 12px' : '16px 8px',
          overflow: 'hidden',
          position: 'relative',
        }}
      >
        {/* Logo and Toggle */}
        <Stack direction="row" alignItems="center" justifyContent={open ? "space-between" : "center"} mb={2}>
          {open && (
            <Box
              component="img"
              src={theme.palette.mode === 'light' ? logoWithNameWhite : logoWithName}
              alt="CoinGraph"
              sx={{
                width: '120px',
                height: '32px',
                objectFit: 'contain',
              }}
            />
          )}
          <IconButton
            onClick={onToggle}
            sx={{
              color: 'text.secondary',
              width: '28px',
              height: '28px',
            }}
          >
            {open ? <ChevronLeftIcon fontSize="small" /> : <MenuIcon fontSize="small" />}
          </IconButton>
        </Stack>

        {/* Ask Predictions Button */}
        <Button
          fullWidth
          variant="contained"
          startIcon={open ? <PredictionsIcon /> : null}
          onClick={() => { onNewChat(); navigate('/ask-predictions'); }}
          sx={{
            backgroundColor: 'primary.main',
            color: 'background.default',
            borderRadius: '8px',
            padding: open ? '10px 14px' : '10px 8px',
            fontSize: open ? '13px' : '11px',
            fontWeight: 600,
            justifyContent: 'center',
            mb: 1.5,
            textTransform: 'none',
            minHeight: '40px',
            '&:hover': {
              backgroundColor: 'primary.dark',
            },
          }}
        >
          {open ? 'Ask Predictions' : <PredictionsIcon sx={{ fontSize: '20px' }} />}
        </Button>

        {/* Section 1: Terminal Navigation Tabs */}
        <Box sx={{ mb: 1, overflowY: 'auto', flex: 1 }}>
          {open && (
            <Typography
              variant="caption"
              sx={{
                color: 'text.secondary',
                fontSize: '10px',
                fontWeight: 600,
                textTransform: 'uppercase',
                letterSpacing: '0.5px',
                px: 1.5,
                mb: 1,
                display: 'block',
              }}
            >
              Terminal
            </Typography>
          )}
          <List sx={{ px: 0 }}>
            {terminalTabs.map((tab) => {
              const Icon = tab.icon;
              const isActive = location.pathname === tab.route;
              return (
                <ListItemButton
                  key={tab.name}
                  component={Link}
                  to={tab.route}
                  selected={isActive}
                  sx={{
                    borderRadius: '8px',
                    mb: 0.5,
                    py: open ? 1 : 1.2,
                    px: open ? 1.5 : 1,
                    flexDirection: open ? 'row' : 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: open ? 'auto' : '60px',
                    '&:hover': {
                      backgroundColor: alpha(theme.palette.text.primary, 0.05),
                    },
                    '&.Mui-selected': {
                      backgroundColor: alpha(theme.palette.primary.main, 0.1),
                      '&:hover': {
                        backgroundColor: alpha(theme.palette.primary.main, 0.15),
                      },
                    },
                  }}
                >
                  <ListItemIcon 
                    sx={{ 
                      minWidth: open ? '32px' : 'auto',
                      color: isActive ? 'primary.main' : 'text.secondary',
                      justifyContent: 'center',
                      mb: open ? 0 : 0.5,
                    }}
                  >
                    <Icon sx={{ fontSize: open ? '18px' : '20px' }} />
                  </ListItemIcon>
                  <ListItemText
                    primary={tab.name}
                    primaryTypographyProps={{
                      fontSize: open ? '12px' : '9px',
                      fontWeight: isActive ? 600 : 400,
                      color: isActive ? 'primary.main' : 'text.primary',
                      textAlign: open ? 'left' : 'center',
                      lineHeight: open ? 'normal' : 1.2,
                    }}
                    sx={{
                      m: 0,
                      '& .MuiListItemText-primary': {
                        whiteSpace: open ? 'normal' : 'nowrap',
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                      }
                    }}
                  />
                </ListItemButton>
              );
            })}
          </List>
        </Box>

        <Divider sx={{ my: 1 }} />

        {/* Theme Toggle at Bottom */}
        <Box
          sx={{
            mt: 'auto',
            pt: 2,
            pb: 2,
            px: open ? 2 : 1,
            display: 'flex',
            justifyContent: open ? 'flex-start' : 'center',
            borderTop: `1px solid ${alpha(theme.palette.divider, 0.2)}`,
          }}
        >
          <ThemeToggle />
        </Box>
      </Box>
    </Drawer>
    </>
  );
};
