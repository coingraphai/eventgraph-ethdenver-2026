# =============================================================================
# DigitalOcean App Platform â€” EventGraph Production Spec
# =============================================================================
#
# Deploy (first time):
#   doctl apps create --spec .do/app.yaml
#
# Update after a push:
#   doctl apps update <APP_ID> --spec .do/app.yaml
#
# Routing (single domain, no CORS issues):
#   /api/*  â†’  backend  (FastAPI, port 8001)
#   /*      â†’  frontend (nginx static, port 80)
#
# BEFORE DEPLOYING â€” replace every value marked ðŸ”‘
# =============================================================================

name: eventgraph-denver
region: nyc

# â”€â”€ Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

services:

  # â”€â”€ 1. Frontend (nginx static site) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: frontend
    github:
      repo: coingraphai/eventgraph-ethdenver-2026
      branch: main
      deploy_on_push: true
    source_dir: frontend           # Docker build context
    dockerfile_path: frontend/Dockerfile  # path from repo root
    http_port: 80
    instance_count: 1
    instance_size_slug: basic-xs
    health_check:
      http_path: /health
      initial_delay_seconds: 15
      period_seconds: 30
      timeout_seconds: 5
      failure_threshold: 3
    routes:
      - path: /                    # catch-all â€” must come AFTER /api route
    envs:
      # Empty string â†’ JS uses relative /api/... paths â†’ DO routes to backend
      - key: VITE_API_URL
        value: ""
        scope: BUILD_TIME
      - key: VITE_API_BASE_URL
        value: ""
        scope: BUILD_TIME

  # â”€â”€ 2. Backend (FastAPI + gunicorn) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: backend
    github:
      repo: coingraphai/eventgraph-ethdenver-2026
      branch: main
      deploy_on_push: true
    source_dir: backend
    dockerfile_path: backend/Dockerfile
    http_port: 8001
    instance_count: 1
    instance_size_slug: professional-xs   # 1 vCPU / 1 GB
    health_check:
      http_path: /health
      initial_delay_seconds: 60
      period_seconds: 15
      timeout_seconds: 10
      failure_threshold: 5
    routes:
      - path: /api
    envs:
      - key: ENVIRONMENT
        value: production

      # â”€â”€ Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: POSTGRES_HOST
        value: REPLACE_WITH_DO_DB_HOST       # ðŸ”‘
        type: SECRET
      - key: POSTGRES_PORT
        value: "25060"
      - key: POSTGRES_DB
        value: defaultdb
      - key: POSTGRES_USER
        value: doadmin
      - key: POSTGRES_PASSWORD
        value: REPLACE_WITH_DO_DB_PASSWORD   # ðŸ”‘
        type: SECRET
      - key: POSTGRES_SSLMODE
        value: require

      - key: DB_POOL_SIZE
        value: "5"
      - key: DB_MAX_OVERFLOW
        value: "10"
      - key: DB_POOL_TIMEOUT
        value: "30"
      - key: DB_POOL_RECYCLE
        value: "1800"

      # â”€â”€ API Keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: DOME_API_KEY
        value: REPLACE_WITH_DOME_API_KEY     # ðŸ”‘
        type: SECRET
      - key: ANTHROPIC_API_KEY
        value: REPLACE_WITH_ANTHROPIC_KEY    # ðŸ”‘
        type: SECRET

      # â”€â”€ CORS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Requests come from same domain via DO's router â€” CORS not normally hit.
      # Update to your live domain after first deploy.
      - key: CORS_ORIGINS
        value: "http://localhost:5173,http://localhost:3000"

      # â”€â”€ Gunicorn tuning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: WEB_CONCURRENCY
        value: "2"

# â”€â”€ Workers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

workers:

  # â”€â”€ 3. Data Pipeline Scheduler (5-min delta loads) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: pipeline
    github:
      repo: coingraphai/eventgraph-ethdenver-2026
      branch: main
      deploy_on_push: true
    source_dir: data-pipeline
    dockerfile_path: data-pipeline/Dockerfile
    instance_count: 1
    instance_size_slug: basic-xs
    envs:
      # â”€â”€ Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: POSTGRES_HOST
        value: REPLACE_WITH_DO_DB_HOST       # ðŸ”‘
        type: SECRET
      - key: POSTGRES_PORT
        value: "25060"
      - key: POSTGRES_DB
        value: defaultdb
      - key: POSTGRES_USER
        value: doadmin
      - key: POSTGRES_PASSWORD
        value: REPLACE_WITH_DO_DB_PASSWORD   # ðŸ”‘
        type: SECRET
      - key: POSTGRES_SSLMODE
        value: require

      - key: DB_POOL_SIZE
        value: "5"
      - key: DB_POOL_MAX_OVERFLOW
        value: "10"
      - key: DB_BATCH_SIZE
        value: "500"

      # â”€â”€ Dome API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: DOME_API_KEY
        value: REPLACE_WITH_DOME_API_KEY     # ðŸ”‘
        type: SECRET
      - key: DOME_API_BASE_URL
        value: "https://api.domeapi.com/v1"
      - key: DOME_RATE_LIMIT_RPS
        value: "50"

      # â”€â”€ Limitless API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: LIMITLESS_API_BASE_URL
        value: "https://api.limitless.exchange"
      - key: LIMITLESS_RATE_LIMIT_RPS
        value: "5"

      # â”€â”€ Schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - key: DELTA_SCHEDULE_INTERVAL_MINUTES
        value: "5"
      - key: POLYMARKET_MAX_MARKETS
        value: "500"
      - key: POLYMARKET_MIN_VOLUME_USD
        value: "50000"
      - key: KALSHI_MAX_MARKETS
        value: "500"
      - key: KALSHI_MIN_VOLUME_USD
        value: "10000"
      - key: TRADES_TOP_N_MARKETS
        value: "0"
      - key: KALSHI_TRADES_TOP_N_MARKETS
        value: "0"
      - key: RETRY_MAX_ATTEMPTS
        value: "5"
      - key: API_TIMEOUT_SECONDS
        value: "30"
      - key: MAX_CONCURRENCY
        value: "5"

# â”€â”€ Jobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:

  # â”€â”€ DB migrations â€” runs automatically BEFORE every deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: db-migrate
    kind: PRE_DEPLOY
    github:
      repo: coingraphai/eventgraph-ethdenver-2026
      branch: main
    source_dir: data-pipeline
    dockerfile_path: data-pipeline/Dockerfile
    run_command: predictions-ingest db migrate
    instance_size_slug: basic-xs
    envs:
      - key: POSTGRES_HOST
        value: REPLACE_WITH_DO_DB_HOST       # ðŸ”‘
        type: SECRET
      - key: POSTGRES_PORT
        value: "25060"
      - key: POSTGRES_DB
        value: defaultdb
      - key: POSTGRES_USER
        value: doadmin
      - key: POSTGRES_PASSWORD
        value: REPLACE_WITH_DO_DB_PASSWORD   # ðŸ”‘
        type: SECRET
      - key: POSTGRES_SSLMODE
        value: require
